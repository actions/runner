# escape=`
FROM mcr.microsoft.com/windows/servercore:ltsc2022

USER ContainerAdministrator

SHELL ["powershell.exe"]

ARG RUNNER_VERSION=2.319.1
ENV RUNNER_VERSION=$RUNNER_VERSION

ENV RUSTUP_HOME='C:\Users\ContainerAdministrator\.rustup' `
    CARGO_HOME='C:\Users\ContainerAdministrator\.cargo' `
    GIT_HOME='C:\Users\ContainerAdministrator\Git' `
    RUNNER_HOME='C:\Users\ContainerAdministrator\runner' `
    RUSTUP_VERSION='1.26.0' `
    RUST_VERSION='1.75.0' `
    RUST_ARCH='x86_64-pc-windows-msvc' `
    RUNNER_ALLOW_RUNASROOT=1 `
    PNPM_CACHE='C:\Users\ContainerAdministrator\.pnpm'

# Download vs
RUN Invoke-WebRequest -UseBasicParsing https://aka.ms/vs/17/release/vs_buildtools.exe -o C:\vs_buildtools.exe; `
    # Install Build Tools with the Microsoft.VisualStudio.Workload.AzureBuildTools workload, excluding workloads and components with known issues.
    C:\vs_buildtools.exe --quiet --wait --norestart --nocache --includeRecommended `
        --add Microsoft.VisualStudio.Workload.VCTools `
        --add Microsoft.VisualStudio.Component.VC.ATL `
        --add Microsoft.VisualStudio.Component.VC.ATL.ARM64 `
        --add Microsoft.VisualStudio.Component.VC.ATL.ARM `
        --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 `
        --add Microsoft.VisualStudio.Component.VC.Tools.ARM `
        --add Microsoft.VisualStudio.Component.VC.Tools.ARM64 `
        --add Microsoft.VisualStudio.Component.Windows11SDK.22621 `
        --add Microsoft.VisualStudio.Workload.AzureBuildTools `
        --add Microsoft.VisualStudio.Component.CoreEditor `
        --add Microsoft.VisualStudio.Workload.CoreEditor `
        --add Microsoft.VisualStudio.Component.TypeScript.TSServer `
        --add Microsoft.VisualStudio.ComponentGroup.WebToolsExtensions `
        --add Microsoft.VisualStudio.Component.JavaScript.TypeScript `
        --add Microsoft.VisualStudio.Component.Roslyn.Compiler `
        --add Microsoft.Component.MSBuild `
        --add Microsoft.VisualStudio.Component.Roslyn.LanguageServices `
        --add Microsoft.VisualStudio.Component.TextTemplating `
        --add Microsoft.VisualStudio.Component.NuGet `
        --add Microsoft.VisualStudio.Component.Debugger.JustInTime `
        --add Component.Microsoft.VisualStudio.LiveShare.2022 `
        --add Microsoft.VisualStudio.Component.IntelliCode `
        --add Microsoft.VisualStudio.Component.VC.CoreIde `
        --add Microsoft.VisualStudio.Component.Graphics.Tools `
        --add Microsoft.VisualStudio.Component.VC.DiagnosticTools `
        --add Microsoft.VisualStudio.Component.Windows11SDK.22000 `
        --add Microsoft.VisualStudio.Component.SecurityIssueAnalysis `
        --add Microsoft.VisualStudio.Component.VC.Redist.14.Latest `
        --add Microsoft.VisualStudio.ComponentGroup.NativeDesktop.Core `
        --add Microsoft.VisualStudio.ComponentGroup.WebToolsExtensions.CMake `
        --add Microsoft.VisualStudio.Component.VC.CMake.Project `
        --add Microsoft.VisualStudio.Component.VC.TestAdapterForBoostTest `
        --add Microsoft.VisualStudio.Component.VC.TestAdapterForGoogleTest `
        --add Microsoft.VisualStudio.Component.VC.ASAN `
        --add Microsoft.VisualStudio.Component.VC.Llvm.ClangToolset `
        --add Microsoft.VisualStudio.Component.VC.Llvm.Clang `
        --add Microsoft.VisualStudio.Component.Vcpkg `
        --add Microsoft.VisualStudio.Workload.NativeDesktop | Out-Null; `
    # Cleanup
    del C:\vs_buildtools.exe; `
    # Download Win10 SDK
    Invoke-WebRequest -UseBasicParsing https://download.microsoft.com/download/9/7/9/97982c1d-d687-41be-9dd3-6d01e52ceb68/windowssdk/winsdksetup.exe -o C:\winsdksetup.exe; `
    C:\winsdksetup.exe /quiet /norestart /log "C:/TEMP/Win10SDK-DesktopDebuggers-Install.log" | Out-Null; `
    del C:\winsdksetup.exe; `
    # Download rust
    Invoke-WebRequest -UseBasicParsing https://win.rustup.rs/x86_64 -o C:\rustup-init.exe; `
    C:\rustup-init.exe -y | Out-Null; `
    del C:\rustup-init.exe; `
    # Download 7-zip
    Invoke-WebRequest -UseBasicParsing https://www.7-zip.org/a/7z2301-x64.exe -o C:\7zip.exe; `
    C:\7zip.exe /S /D="C:\Users\ContainerAdministrator\7-Zip" | Out-Null; `
    del C:\7zip.exe; `
    # Download git
    Invoke-WebRequest -UseBasicParsing https://github.com/git-for-windows/git/releases/download/v2.44.0.windows.1/Git-2.44.0-64-bit.tar.bz2 -o C:\Git.tar.bz2; `
    C:\Users\ContainerAdministrator\7-Zip\7z.exe x C:\Git.tar.bz2 | Out-Null; `
    C:\Users\ContainerAdministrator\7-Zip\7z.exe x C:\Git.tar -o"""$env:GIT_HOME""" | Out-Null; `
    $path=$env:GIT_HOME + '\cmd;' + $env:GIT_HOME + '\bin;' + $env:GIT_HOME + '\usr\bin;' + $env:path; `
    Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment\' -Name Path -Value $path; `
    del C:\Git.tar; `
    del C:\Git.tar.bz2; `
    # install github runner
    Invoke-WebRequest -UseBasicParsing https://github.com/actions/runner/releases/download/v${env:RUNNER_VERSION}/actions-runner-win-x64-${env:RUNNER_VERSION}.zip -o C:\actions-runner.zip; `
    Expand-Archive C:\actions-runner.zip -DestinationPath $env:RUNNER_HOME; `
    del C:\actions-runner.zip; `
    # npm
    mkdir -p $env:USERPROFILE/AppData/Local/pnpm/config; `
    echo "store-dir=${env:PNPM_CACHE}" | Out-File $env:USERPROFILE/AppData/Local/pnpm/config/rc -Encoding "UTF8";

# intall pwsh
RUN Invoke-WebRequest -Uri https://github.com/PowerShell/PowerShell/releases/download/v7.4.1/PowerShell-7.4.1-win-x64.msi -OutFile pwsh-installer.msi; `
    msiexec.exe /package pwsh-installer.msi /quiet ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL=1 ADD_FILE_CONTEXT_MENU_RUNPOWERSHELL=1 ENABLE_PSREMOTING=1 REGISTER_MANIFEST=1 USE_MU=1 ENABLE_MU=1 ADD_PATH=1;

RUN git config --system core.compression 0  
RUN git config --system core.longpaths true
RUN git config --global http.sslBackend openssl

# Disable path limit
RUN powershell Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem' -Name LongPathsEnabled -Type DWord -Value 1

WORKDIR C:\Users\ContainerAdministrator\runner
# Setup custom runner hook.
ENV ACTIONS_RUNNER_HOOK_JOB_STARTED='C:\Users\ContainerAdministrator\runner\misc\hook.ps1'
COPY hook.ps1 .\misc\hook.ps1
