name: NPM Audit Fix

on:
  schedule:
    - cron: "0 7 * * 1" # Weekly
  workflow_dispatch:

jobs:
  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: NPM install and audit fix
        working-directory: src/Misc/expressionFunc/hashFiles
        run: |
          npm install
          
          # Check for vulnerabilities first
          echo "Checking for npm vulnerabilities..."
          if npm audit --audit-level=moderate; then
            echo "âœ… No moderate or higher vulnerabilities found"
            echo "AUDIT_NEEDED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "âš ï¸ Vulnerabilities found, attempting npm audit fix..."
          echo "AUDIT_NEEDED=true" >> $GITHUB_ENV
          
          # Attempt audit fix and capture the result
          if npm audit fix; then
            echo "âœ… npm audit fix completed successfully"
            echo "AUDIT_FIX_STATUS=success" >> $GITHUB_ENV
          else
            echo "âš ï¸ npm audit fix failed or had issues"
            
            # Check if critical/high vulnerabilities remain
            if ! npm audit --audit-level=high; then
              echo "ðŸš¨ Critical/high vulnerabilities remain - manual intervention required"
              echo "AUDIT_FIX_STATUS=failed-critical" >> $GITHUB_ENV
            else
              echo "âœ… Only moderate/low vulnerabilities remain after failed fix"
              echo "AUDIT_FIX_STATUS=failed-minor" >> $GITHUB_ENV
            fi
          fi
          
      - name: Create PR if changes exist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0  # Disable husky hooks for automated commits
        run: |
          # Check if there are any changes
          if [ -n "$(git status --porcelain)" ]; then
            # Configure git
            git config --global user.name "github-actions[bot]"
            git config --global user.email "<41898282+github-actions[bot]@users.noreply.github.com>"

            # Create branch and commit changes
            branch_name="chore/npm-audit-fix"
            git checkout -b "$branch_name"
            
            # Commit with --no-verify to skip husky hooks
            git commit -a -m "chore: npm audit fix for hashFiles dependencies" --no-verify
            git push --force origin "$branch_name"
            
            # Check if build passes after changes
            build_status="âœ… Build passes"
            cd src/Misc/expressionFunc/hashFiles
            if ! npm run build 2>/dev/null; then
              build_status="âš ï¸ Build fails - TypeScript auto-fix workflow recommended"
            fi
            cd - > /dev/null
            
            # Determine audit status message
            audit_status_msg=""
            if [[ "$AUDIT_NEEDED" == "false" ]]; then
              audit_status_msg="â„¹ï¸ **Audit Status**: No vulnerabilities found"
            else
              case "$AUDIT_FIX_STATUS" in
                "success")
                  audit_status_msg="âœ… **Audit Fix**: Completed successfully"
                  ;;
                "failed-minor")
                  audit_status_msg="âš ï¸ **Audit Fix**: Failed, but only minor vulnerabilities remain"
                  ;;
                "failed-critical")
                  audit_status_msg="ðŸš¨ **Audit Fix**: Failed with critical/high vulnerabilities remaining"
                  ;;
                *)
                  audit_status_msg="â“ **Audit Fix**: Status unknown"
                  ;;
              esac
            fi
            
            # Create PR body using here-doc for proper formatting
            if [[ "$build_status" == *"fails"* ]]; then
              cat > pr_body.txt << EOF
          Automated npm audit fix for security vulnerabilities in hashFiles dependencies.
          
          **Build Status**: âš ï¸ Build fails - TypeScript auto-fix workflow recommended
          $audit_status_msg
          
          This PR was automatically created to address npm security advisories.
          
          âš ï¸ **Action Required**: The build is failing after the audit fix.
          
          **Next Steps**:
          1. Run the 'NPM Audit Fix with TypeScript Auto-Fix' workflow for automated fixes
          2. Or manually fix TypeScript compatibility issues
          3. Common issue: @types/node version incompatibility - try updating to Node 20 compatible version
          
          ---
          
          Autogenerated by [NPM Audit Fix Workflow](https://github.com/actions/runner/blob/main/.github/workflows/npm-upgrade.yml)
          EOF
            else
              cat > pr_body.txt << EOF
          Automated npm audit fix for security vulnerabilities in hashFiles dependencies.
          
          **Build Status**: âœ… Build passes
          $audit_status_msg
          
          This PR was automatically created to address npm security advisories.
          
          âœ… **Ready to Merge**: Audit fix successful with no build issues.
          
          ---
          
          Autogenerated by [NPM Audit Fix Workflow](https://github.com/actions/runner/blob/main/.github/workflows/npm-upgrade.yml)
          EOF
            fi
            
            # Determine appropriate labels based on status
            labels="dependency"
            if [[ "$AUDIT_FIX_STATUS" == "failed-critical" ]]; then
              labels="dependency,security,needs-manual-review"
            elif [[ "$build_status" == *"fails"* ]]; then
              labels="dependency,needs-manual-review"
            fi
            
            # Create PR (without label since it may not exist)
            gh pr create -B main -H "$branch_name" \
              --title "chore: npm audit fix for hashFiles dependencies" \
              --body-file pr_body.txt || \
            # Fallback: try with explicit label creation
            (gh label create "dependency" --description "Dependency updates" --color "0366d6" 2>/dev/null || true && \
             gh label create "security" --description "Security-related changes" --color "D93F0B" 2>/dev/null || true && \
             gh label create "needs-manual-review" --description "Requires manual review" --color "B60205" 2>/dev/null || true && \
             gh pr create -B main -H "$branch_name" \
               --title "chore: npm audit fix for hashFiles dependencies" \
               --label "$labels" \
               --body-file pr_body.txt)
          elif [[ "$AUDIT_NEEDED" == "true" && "$AUDIT_FIX_STATUS" == "failed-critical" ]]; then
            echo "ðŸš¨ CRITICAL: npm audit fix failed with critical/high vulnerabilities but no file changes occurred!"
            echo "This may indicate that the vulnerabilities could not be resolved automatically."
            exit 1
          else
            echo "No changes to commit"
          fi
