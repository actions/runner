name: NPM Audit Fix

on:
  schedule:
    - cron: "0 7 * * 1" # Weekly
  workflow_dispatch:

jobs:
  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: NPM install and audit fix
        working-directory: src/Misc/expressionFunc/hashFiles
        run: |
          npm install
          npm audit fix || true
          
          # Try to run the build to see if there are any issues after audit fix
          npm run build || echo "Build failed after audit fix - this may require manual intervention"
          
      - name: Create PR if changes exist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0  # Disable husky hooks for automated commits
        run: |
          # Check if there are any changes
          if [ -n "$(git status --porcelain)" ]; then
            # Configure git
            git config --global user.name "github-actions[bot]"
            git config --global user.email "<41898282+github-actions[bot]@users.noreply.github.com>"

            # Create branch and commit changes
            branch_name="chore/npm-audit-fix"
            git checkout -b "$branch_name"
            
            # Commit with --no-verify to skip husky hooks
            git commit -a -m "chore: npm audit fix for hashFiles dependencies" --no-verify
            git push --force origin "$branch_name"
            
            # Check if build passes after changes
            build_status="✅ Build passes"
            cd src/Misc/expressionFunc/hashFiles
            if ! npm run build; then
              build_status="⚠️ Build fails - manual review required"
            fi
            cd - > /dev/null
            
            # Create PR body
            pr_body="Automated npm audit fix for security vulnerabilities in hashFiles dependencies."
            pr_body+="\n\n**Build Status**: $build_status"
            pr_body+="\n\nThis PR was automatically created to address npm security advisories."
            if [[ "$build_status" == *"fails"* ]]; then
              pr_body+="\n\n⚠️ **Note**: The build is currently failing after the audit fix. This likely indicates type compatibility issues that require manual review and fixing."
            fi
            pr_body+="\n\n---\n\nAutogenerated by [NPM Audit Fix Workflow](https://github.com/actions/runner/blob/main/.github/workflows/npm-upgrade.yml)"
            
            # Create PR
            gh pr create -B main -H "$branch_name" \
              --title "chore: npm audit fix for hashFiles dependencies" \
              --label "dependency" \
              --body "$pr_body"
          else
            echo "No changes to commit"
          fi
