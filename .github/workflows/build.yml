name: Runner CI

on:
  workflow_dispatch:
  push:
    branches:
    - main
    - releases/*
    paths-ignore:
    - '**.md'    
  pull_request:
    branches:
    - '*'
    paths-ignore:
    - '**.md'    

jobs:
  build:
    strategy:
      matrix:
        rid: [ linux-x64, linux-arm64, linux-arm, win-x64, osx-x64 ]
        include:
        - rid: linux-x64
          os: ubuntu-latest
        - rid: linux-arm64
          os: ubuntu-latest
        - rid: linux-arm
          os: ubuntu-latest
        - rid: osx-x64
          os: macOS-latest
        - rid: win-x64
          os: windows-latest
        
        
        
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2
      if: matrix.os == 'windows-latest'

    
    - name: Build 
      run: |
        ./tools/StartBuild.ps1 ${{ matrix.rid }}
      shell: pwsh

    - name: Layout
      run: |
        ./tools/StartLayout.ps1 ${{ matrix.rid }}
      shell: pwsh 

    # Run tests
    - name: L0
      run: |
        ./tools/StartTest.ps1 ${{ matrix.rid }}
      shell: pwsh
      if: matrix.rid != 'linux-arm64' && matrix.rid != 'linux-arm'

    # Create runner package tar.gz/zip
    - name: Package
      if: github.event_name != 'pull_request'
      run: |
        ./tools/StartPackage.ps1 ${{ matrix.rid }}
      shell: pwsh 

    # Upload runner package tar.gz/zip as artifact
    - name: Publish Artifact
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v1
      with:
        name: runner-package-${{ matrix.rid }}
        path: _package
